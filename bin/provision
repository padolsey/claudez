#!/usr/bin/env bash
set -Eeuo pipefail
SELF_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(cd "$SELF_DIR/.." && pwd)"
. "$ROOT_DIR/lib/common.sh"

SUB="${1:-}"; shift || true
case "$SUB" in
  create)  exec "$SELF_DIR/provision-create" "$@" ;;
  spawn)   exec "$SELF_DIR/provision-spawn" "$@" ;;
  enter)   exec "$SELF_DIR/provision-enter" "$@" ;;
  shell)   exec "$SELF_DIR/provision-shell" "$@" ;;
  reset)   exec "$SELF_DIR/provision-reset" "$@" ;;
  status)  exec "$SELF_DIR/provision-status" "$@" ;;
  ls)      exec "$SELF_DIR/provision-ls" "$@" ;;
  rm)      exec "$SELF_DIR/provision-rm" "$@" ;;
  logs)    exec "$SELF_DIR/provision-logs" "$@" ;;
  restart) exec "$SELF_DIR/provision-restart" "$@" ;;
  stop)    exec "$SELF_DIR/provision-stop" "$@" ;;
  start)   exec "$SELF_DIR/provision-start" "$@" ;;
  exec)    exec "$SELF_DIR/provision-exec" "$@" ;;
  setup-status-page) exec "$SELF_DIR/provision-setup-status-page" "$@" ;;
  protect-services) exec "$SELF_DIR/provision-protect-services" "$@" ;;
  ""|--help|-h)
    cat <<'EOF'
Usage:
  provision create <name> [--verify] # build + up + bootstrap (--verify checks Traefik routing)
  provision spawn  <name> [--verify] # create + enter in one command
  provision enter  <name>         # open shell & start/attach Claude (tmux)
  provision shell  <name>         # open normal shell without starting Claude
  provision reset  <name>         # remove container/image/app dir then recreate
  provision status <name>         # health checks (vanilla/Traefik)
  provision ls                    # list all provisioned apps with status
  provision rm     <name> [--force] # permanently delete app
  provision logs   <name> [options] # view container logs (-f, --tail, etc)
  provision restart <name> [--force] # restart container
  provision stop   <name> [--force] # stop container
  provision start  <name>         # start stopped container
  provision exec   <name> <cmd>   # run command in container as appuser
  provision setup-status-page [interval] # deploy status page at status.${DOMAIN_BASE} (default: 30s)
  provision protect-services # protect Docker/Traefik/SSH from OOM killer
EOF
    ;;
  *) die "Unknown subcommand: $SUB" ;;
esac
