#!/usr/bin/env bash
set -Eeuo pipefail
SELF_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(cd "$SELF_DIR/.." && pwd)"
. "$ROOT_DIR/lib/common.sh"

NAME="${1:-}"; [ -z "$NAME" ] && die "Usage: claudez enter <name>"
CONTAINER_NAME="${NAME}-app"

need docker

# Check if container exists
if ! docker ps -a --format '{{.Names}}' | grep -qx "$CONTAINER_NAME"; then
  die "Container '${CONTAINER_NAME}' not found. Create it first with: claudez create ${NAME}"
fi

# Check if container is running
if ! docker ps --format '{{.Names}}' | grep -qx "$CONTAINER_NAME"; then
  die "Container '${CONTAINER_NAME}' exists but is not running. Start it with: claudez start ${NAME}"
fi

# Detect which agent this zone uses and launch the correct one
# Check for OpenCode config to determine agent type
if docker exec -u appuser "$CONTAINER_NAME" bash -lc '[ -f /workspace/.opencode/opencode.json ]' 2>/dev/null; then
  # OpenCode zone - launch opencode
  exec docker exec -it -u appuser "$CONTAINER_NAME" bash -lc 'command -v opencode >/dev/null && opencode || bash'
else
  # Claude Code zone - launch tclaude (tmux-backed)
  exec docker exec -it -u appuser "$CONTAINER_NAME" bash -lc 'command -v tclaude >/dev/null && tclaude || claude || bash'
fi
